ULS杯 ISUCON#2マニュアル
===

## ルール詳細

指定された競技用アプリケーションのチューニングを行い、それに対するベンチマーク走行のスコアで競技を行います。
利用が認められた競技用サーバーのみでアプリケーションの動作が可能であれば、どのような変更を加えても構いません。

ベンチマーカーとブラウザの挙動に差異がある場合、ベンチマーカーの挙動を正とします。

また、初期実装は言語毎に若干の挙動の違いはありますが、ベンチマーカーに影響のない挙動に関しては仕様とします。


## 制約事項

以下の事項に抵触すると失格(fail)となり、点数が0点になります。

- `POST /initialize` へのレスポンスを20秒以内に返さない場合
- アプリケーション互換性チェックに失敗した場合
- アプリケーションがレスポンスを10秒以内に返さない場合
- その他、ベンチマーカーのチェッカが失敗を検出したケース

最初に呼ばれる初期化処理 `POST /initialize` は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。
サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。

- アプリケーションは全て保存データを永続化する必要があります
  - 処理実施後に再起動が行われた場合、再起動前に行われた処理内容が再起動後に保存されている必要があります
- アプリケーションはブラウザ上での表示を初期状態と同様に保つ必要があります
- 以下に示す改変を行ってはなりません
  - パスワードを平文で保存する

### POST /initialize

ISUCAR DB起動時にdocker-entrypoint-initdb.dを使用してデータベースを初期化しています。
意図的に初期化したい場合は、以下のように手動で `POST /initialize` を叩いて設定を反映してください。

```
$ cat initialize.json
{
  "payment_service_url":"http://localhost:5555",
  "shipment_service_url":"http://localhost:7000"
}
$ curl -XPOST http://127.0.0.1:8000/initialize \
-H 'Content-Type: application/json' \
-d @initialize.json
```

またinitialize処理はベンチマーク走行時に必ず実行されるので、ベンチマーク走行後に初期状態から確認したい場合も都度実行する必要があります。


## キャンペーン機能

`POST /initialize` のレスポンスにて、ｲｽｺｲﾝ還元キャンペーンの「還元率の設定」を返すことができます。この還元率によりユーザが増減します。

`POST /initialize` のレスポンスは JSON 形式で

```
{
    "campaign": 0,
    "language": "実装言語"
}
```

campaignが還元率の設定となります。有効な値は 0 以上 4 以下の整数で 0 の場合はキャンペーン機能が無効になります。

languageについては別の項目で説明しています。

なお、ｲｽｺｲﾝ還元の費用が下で説明するスコアから引かれることはありません。

ただし、このキャンペーン機能は本計測環境では無効です。ローカル環境でのテストで負荷を上げて確認したい場合にのみご利用ください。


## 商品取得APIと更新の反映について

ISUCARIには以下の商品取得APIがあります。

- 新着一覧
- カテゴリ毎新着一覧
- ユーザ毎一覧
- 取引一覧
- 商品詳細

商品が出品・編集された場合は、カテゴリ毎新着一覧、ユーザ毎一覧、取引一覧、商品詳細APIに即座に反映してください。
編集・購入された商品については、全ての商品一覧・詳細取得APIで即座に情報を更新してください。
古いデータの削除、非表示はベンチマーク上で許可されません。各商品一覧取得APIが一度に返す商品数は初期実装と同じ状態を保つ必要があります。
新着一覧については、上記の制限を満たした上でよりユーザにあわせた商品の一覧を返すことで、購入の機会を増やすことができます。


## ベンチマーク走行

ベンチマーク走行は以下のように実施されます。

1. 初期化処理の実行 `POST /initialize`（20秒以内）
2. アプリケーション互換性チェックの走行（適宜: 数秒〜数十秒）
3. 負荷走行（60秒）
4. 負荷走行後の確認（適宜: 数秒〜数十秒）

各ステップで失敗が見付かった場合にはその時点で停止します。
ただし、負荷走行中のエラーについては、タイムアウトや500エラーを含む幾つかのエラーについては無視され、ベンチマーク走行が継続します。

また負荷走行が60秒行われた後、レスポンスが返ってきていないリクエストはすべて強制的に切断されます。
その際にnginxのアクセスログにステータスコード499が記録されることがありますが、これらのリクエストについては減点の対象外です。


## スコア計算

スコアは**取引が完了した商品（椅子）の価格の合計（ｲｽｺｲﾝ）** をベースに以下の計算式で計算されます。

```
取引が完了した商品（椅子）の価格の合計（ｲｽｺｲﾝ） - 減点 = スコア（ｲｽｺｲﾝ）
```

以下の条件のエラーが発生すると、失格・減点の対象となります。

- 致命的なエラー
  - 1回以上で失格
  - メッセージの最後に `(critical error)` が付与されます
- HTTPステータスコードやレスポンスの内容などに誤りがある
  - 1回で500ｲｽｺｲﾝ減点、10回以上で失格
- 一定時間内にレスポンスが返却されない・タイムアウト
  - 200回を超えたら100回毎に5000ｲｽｺｲﾝ減点、失格はなし
  - メッセージの最後に `（タイムアウトしました）` か `（一時的なエラー）` が付与されます

HTTPステータスコードは、基本的に参照実装と同一のものを想定しています。またベンチマーカーのメッセージは同一のメッセージを1つにまとめます。表示されているメッセージの数とエラー数は一致しないことがあります。

また減点により0ｲｽｺｲﾝ以下になった場合は失格となります。


## サポートするMySQLのバージョン

MySQL 5.7および8.0にて動作確認しています。

ただし、nodejsでアプケーションを起動する場合、MySQL 8.0の認証方式によっては動作しないことがあります。
詳しくは、 https://github.com/isucon/isucon9-qualify/pull/316 を参考にしてください


## リカバリ方法

DB(isucari)を初期状態にもどすには、次のコマンドを実行します。

```sh
$ /sql/init.bash
```


## `POST /initialize` での実装言語の出力

`POST /initialize` のレスポンスにて、本競技で利用した言語を出力してください。参考情報として利用させていただきます。

`POST /initialize` のレスポンスは次のような JSON 形式になります。

```
{
    "campaign": 0,
    "language": "実装言語"
}
```

languageの値が実装に利用した言語となります。languageが空の場合はベンチマーカーは失敗と見なされます。
